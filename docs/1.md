# 小白如何快速上手 React 源码

作为一个想要深入了解 React 内部工作原理的开发者，阅读 React 源码是提升技能的重要途径。本文将带你快速了解 React 源码的组织结构，帮助你建立对 React 源码的整体认知。

## React 仓库结构

React 源码采用 Monorepo 架构，主要目录结构如下：

react/
├── packages/ # 核心包目录
├── fixtures/ # 测试用例和示例
├── scripts/ # 构建和开发脚本
├── compiler/ # React 编译器相关代码
├── .github/ # GitHub 配置文件
├── dangerfile.js # 代码审查自动化
├── babel.config.js # Babel 配置
└── yarn.lock # 依赖锁定文件

**packages 目录**是整个仓库的核心，包含了 React 的所有功能模块。

**scripts 目录**包含了构建、测试、发布等自动化脚本，是了解 React 开发流程的重要参考。

**fixtures 目录**提供了大量的测试用例和示例应用，可以帮助理解 React 的各种特性和用法。

**compiler 目录**是 React 编译器（React Compiler）的相关代码，这是 React 的新特性。

### 主要特点

- **Monorepo 架构**：所有相关包都在一个仓库中管理，便于统一维护和版本控制
- **模块化设计**：每个功能都被拆分成独立的包，职责清晰，便于理解和维护
- **统一构建**：使用统一的构建脚本和配置，确保所有包的构建一致性
- **版本同步**：所有包版本保持同步更新，避免版本兼容性问题

## packages 目录解析

packages 目录是 React 源码的心脏，包含了 30+个独立的 npm 包。让我们按功能分类来了解：

### 🎯 核心包

#### 1. react

- **作用**：React 的核心 API 和组件系统
- **包含**：createElement、useState、useEffect 等核心 API
- **入口文件**：`packages/react/index.js`

#### 2. react-reconciler

- **作用**：React 的协调算法核心，负责虚拟 DOM diff 和更新
- **包含**：Fiber 架构、调度算法、生命周期管理
- **说明**：这是理解 React 工作原理的关键包

#### 3. scheduler

- **作用**：任务调度器，实现时间切片和优先级调度
- **包含**：任务队列、时间切片、优先级管理
- **说明**：React 并发特性的基础

### 🎨 渲染器包

#### 4. react-dom

- **作用**：React 在浏览器环境的渲染器
- **包含**：DOM 操作、事件系统、服务端渲染
- **主要文件**：
  - `client.js` - 客户端渲染
  - `server.js` - 服务端渲染
  - `test-utils.js` - 测试工具

#### 5. react-native-renderer

- **作用**：React Native 的渲染器
- **说明**：了解跨平台渲染的实现

#### 6. react-art

- **作用**：用于绘图和动画的渲染器
- **说明**：展示了自定义渲染器的实现方式

#### 7. react-test-renderer

- **作用**：用于测试的渲染器
- **说明**：不依赖 DOM 环境的测试工具

### 🛠️ 开发工具包

#### 8. react-devtools 系列

- **react-devtools** - 独立的开发者工具
- **react-devtools-extensions** - 浏览器扩展
- **react-devtools-shared** - 共享工具代码
- **react-devtools-core** - 核心功能

#### 9. eslint-plugin-react-hooks

- **作用**：React Hooks 的 ESLint 规则

### 🚀 服务端和新特性包

#### 10. react-server 系列

- **react-server** - React 服务端组件
- **react-server-dom-webpack** - Webpack 集成
- **react-server-dom-parcel** - Parcel 集成
- **说明**：React 18+的服务端组件特性

#### 11. 工具包

- **react-is** - React 元素类型判断工具
- **react-refresh** - 热重载功能
- **shared** - 各包共享的工具函数
- **use-subscription** - 订阅 Hook
- **use-sync-external-store** - 外部状态同步 Hook

## React 架构

了解了 React 源码目录之后，我们再来对 React 架构有个大体的认识，了解 React 是如何在变量更改时，页面发生更新渲染的。

### 整体架构设计

![image](images/1-1.png)
React 架构可以分为三个主要层次：

#### 1. 调度层（Scheduler）

**源码位置**：`packages/scheduler/`

- **核心功能**：任务调度和优先级管理
- **主要文件**：
  - `src/Scheduler.js` - 调度器核心逻辑
  - `src/SchedulerPriorities.js` - 优先级定义
  - `src/forks/SchedulerHostConfig.default.js` - 宿主环境配置

调度层负责：

- 时间切片（Time Slicing）
- 任务优先级排序
- 可中断的渲染过程
- 浏览器空闲时间利用

#### 2. 协调层（Reconciler）

**源码位置**：`packages/react-reconciler/`

- **核心功能**：虚拟 DOM diff 算法和 Fiber 架构
- **主要文件**：
  - `src/ReactFiberReconciler.js` - 协调器入口
  - `src/ReactFiberWorkLoop.js` - 工作循环
  - `src/ReactFiberBeginWork.js` - 开始工作阶段
  - `src/ReactFiberCompleteWork.js` - 完成工作阶段
  - `src/ReactFiberCommitWork.js` - 提交阶段

协调层负责：

- Virtual DOM 树的构建和比较
- Fiber 节点的创建和更新
- 组件生命周期管理
- 副作用（Effects）收集

#### 3. 渲染层（Renderer）

**源码位置**：`packages/react-dom/`、`packages/react-native-renderer/` 等

- **核心功能**：将虚拟 DOM 转换为实际的 UI
- **主要文件**（以 react-dom 为例）：
  - `src/client/ReactDOMRoot.js` - 根节点管理
  - `src/client/ReactDOMComponent.js` - DOM 组件处理
  - `src/events/DOMPluginEventSystem.js` - 事件系统
  - `src/server/ReactDOMServerFormatConfig.js` - 服务端渲染

### 更新流程

![image](images/1-2.png)

#### 1. 触发更新

**源码位置**：`packages/react/src/ReactHooks.js`

当调用 `setState` 或 `useState` 的 setter 时：

```javascript
// useState 的实现位置
// packages/react-reconciler/src/ReactFiberHooks.js
function dispatchSetState(fiber, queue, action) {
  // 创建更新对象
  const update = createUpdate(eventTime, lane);
  update.action = action;

  // 将更新加入队列
  enqueueUpdate(fiber, queue, update, lane);

  // 调度更新
  scheduleUpdateOnFiber(fiber, lane, eventTime);
}
```

#### 2. 调度阶段

**源码位置**：`packages/react-reconciler/src/ReactFiberWorkLoop.js`

```javascript
// 调度更新的核心函数
function scheduleUpdateOnFiber(fiber, lane, eventTime) {
  // 标记从当前fiber到root的路径
  const root = markUpdateLaneFromFiberToRoot(fiber, lane);

  // 标记root有待处理的更新
  markRootUpdated(root, lane, eventTime);

  // 确保root被调度
  ensureRootIsScheduled(root, eventTime);
}
```

#### 3. 渲染阶段（Render Phase）

**源码位置**：`packages/react-reconciler/src/ReactFiberBeginWork.js`

这个阶段是可中断的，主要工作：

- 构建新的 Fiber 树
- 标记需要更新的节点
- 收集副作用

```javascript
// 开始工作的核心函数
function beginWork(current, workInProgress, renderLanes) {
  switch (workInProgress.tag) {
    case FunctionComponent:
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes
      );
    case ClassComponent:
      return updateClassComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes
      );
    case HostComponent:
      return updateHostComponent(current, workInProgress, renderLanes);
    // ... 其他组件类型
  }
}
```

#### 4. 提交阶段（Commit Phase）

**源码位置**：`packages/react-reconciler/src/ReactFiberCommitWork.js`

这个阶段是同步的，不可中断：

- 执行 DOM 操作
- 调用生命周期方法
- 执行副作用

```javascript
// 提交阶段的核心函数
function commitRoot(root) {
  // 提交前的准备工作
  commitBeforeMutationEffects(root, finishedWork);

  // 执行DOM变更
  commitMutationEffects(root, finishedWork, lanes);

  // 切换fiber树
  root.current = finishedWork;

  // 提交后的清理工作
  commitLayoutEffects(finishedWork, root, lanes);
}
```

## 最后

本文简单介绍了一下 react 目录结构和核心架构，具体的细节会在后续再介绍。
