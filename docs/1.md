# å°ç™½å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ React æºç 

ä½œä¸ºä¸€ä¸ªæƒ³è¦æ·±å…¥äº†è§£ React å†…éƒ¨å·¥ä½œåŸç†çš„å¼€å‘è€…ï¼Œé˜…è¯» React æºç æ˜¯æå‡æŠ€èƒ½çš„é‡è¦é€”å¾„ã€‚æœ¬æ–‡å°†å¸¦ä½ å¿«é€Ÿäº†è§£ React æºç çš„ç»„ç»‡ç»“æ„ï¼Œå¸®åŠ©ä½ å»ºç«‹å¯¹ React æºç çš„æ•´ä½“è®¤çŸ¥ã€‚

## React ä»“åº“ç»“æ„

React æºç é‡‡ç”¨ Monorepo æ¶æ„ï¼Œä¸»è¦ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

react/
â”œâ”€â”€ packages/ # æ ¸å¿ƒåŒ…ç›®å½•
â”œâ”€â”€ fixtures/ # æµ‹è¯•ç”¨ä¾‹å’Œç¤ºä¾‹
â”œâ”€â”€ scripts/ # æ„å»ºå’Œå¼€å‘è„šæœ¬
â”œâ”€â”€ compiler/ # React ç¼–è¯‘å™¨ç›¸å…³ä»£ç 
â”œâ”€â”€ .github/ # GitHub é…ç½®æ–‡ä»¶
â”œâ”€â”€ dangerfile.js # ä»£ç å®¡æŸ¥è‡ªåŠ¨åŒ–
â”œâ”€â”€ babel.config.js # Babel é…ç½®
â””â”€â”€ yarn.lock # ä¾èµ–é”å®šæ–‡ä»¶

**packages ç›®å½•**æ˜¯æ•´ä¸ªä»“åº“çš„æ ¸å¿ƒï¼ŒåŒ…å«äº† React çš„æ‰€æœ‰åŠŸèƒ½æ¨¡å—ã€‚

**scripts ç›®å½•**åŒ…å«äº†æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒç­‰è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œæ˜¯äº†è§£ React å¼€å‘æµç¨‹çš„é‡è¦å‚è€ƒã€‚

**fixtures ç›®å½•**æä¾›äº†å¤§é‡çš„æµ‹è¯•ç”¨ä¾‹å’Œç¤ºä¾‹åº”ç”¨ï¼Œå¯ä»¥å¸®åŠ©ç†è§£ React çš„å„ç§ç‰¹æ€§å’Œç”¨æ³•ã€‚

**compiler ç›®å½•**æ˜¯ React ç¼–è¯‘å™¨ï¼ˆReact Compilerï¼‰çš„ç›¸å…³ä»£ç ï¼Œè¿™æ˜¯ React çš„æ–°ç‰¹æ€§ã€‚

### ä¸»è¦ç‰¹ç‚¹

- **Monorepo æ¶æ„**ï¼šæ‰€æœ‰ç›¸å…³åŒ…éƒ½åœ¨ä¸€ä¸ªä»“åº“ä¸­ç®¡ç†ï¼Œä¾¿äºç»Ÿä¸€ç»´æŠ¤å’Œç‰ˆæœ¬æ§åˆ¶
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªåŠŸèƒ½éƒ½è¢«æ‹†åˆ†æˆç‹¬ç«‹çš„åŒ…ï¼ŒèŒè´£æ¸…æ™°ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
- **ç»Ÿä¸€æ„å»º**ï¼šä½¿ç”¨ç»Ÿä¸€çš„æ„å»ºè„šæœ¬å’Œé…ç½®ï¼Œç¡®ä¿æ‰€æœ‰åŒ…çš„æ„å»ºä¸€è‡´æ€§
- **ç‰ˆæœ¬åŒæ­¥**ï¼šæ‰€æœ‰åŒ…ç‰ˆæœ¬ä¿æŒåŒæ­¥æ›´æ–°ï¼Œé¿å…ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

## packages ç›®å½•è§£æ

packages ç›®å½•æ˜¯ React æºç çš„å¿ƒè„ï¼ŒåŒ…å«äº† 30+ä¸ªç‹¬ç«‹çš„ npm åŒ…ã€‚è®©æˆ‘ä»¬æŒ‰åŠŸèƒ½åˆ†ç±»æ¥äº†è§£ï¼š

### ğŸ¯ æ ¸å¿ƒåŒ…

#### 1. react

- **ä½œç”¨**ï¼šReact çš„æ ¸å¿ƒ API å’Œç»„ä»¶ç³»ç»Ÿ
- **åŒ…å«**ï¼šcreateElementã€useStateã€useEffect ç­‰æ ¸å¿ƒ API
- **å…¥å£æ–‡ä»¶**ï¼š`packages/react/index.js`

#### 2. react-reconciler

- **ä½œç”¨**ï¼šReact çš„åè°ƒç®—æ³•æ ¸å¿ƒï¼Œè´Ÿè´£è™šæ‹Ÿ DOM diff å’Œæ›´æ–°
- **åŒ…å«**ï¼šFiber æ¶æ„ã€è°ƒåº¦ç®—æ³•ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **è¯´æ˜**ï¼šè¿™æ˜¯ç†è§£ React å·¥ä½œåŸç†çš„å…³é”®åŒ…

#### 3. scheduler

- **ä½œç”¨**ï¼šä»»åŠ¡è°ƒåº¦å™¨ï¼Œå®ç°æ—¶é—´åˆ‡ç‰‡å’Œä¼˜å…ˆçº§è°ƒåº¦
- **åŒ…å«**ï¼šä»»åŠ¡é˜Ÿåˆ—ã€æ—¶é—´åˆ‡ç‰‡ã€ä¼˜å…ˆçº§ç®¡ç†
- **è¯´æ˜**ï¼šReact å¹¶å‘ç‰¹æ€§çš„åŸºç¡€

### ğŸ¨ æ¸²æŸ“å™¨åŒ…

#### 4. react-dom

- **ä½œç”¨**ï¼šReact åœ¨æµè§ˆå™¨ç¯å¢ƒçš„æ¸²æŸ“å™¨
- **åŒ…å«**ï¼šDOM æ“ä½œã€äº‹ä»¶ç³»ç»Ÿã€æœåŠ¡ç«¯æ¸²æŸ“
- **ä¸»è¦æ–‡ä»¶**ï¼š
  - `client.js` - å®¢æˆ·ç«¯æ¸²æŸ“
  - `server.js` - æœåŠ¡ç«¯æ¸²æŸ“
  - `test-utils.js` - æµ‹è¯•å·¥å…·

#### 5. react-native-renderer

- **ä½œç”¨**ï¼šReact Native çš„æ¸²æŸ“å™¨
- **è¯´æ˜**ï¼šäº†è§£è·¨å¹³å°æ¸²æŸ“çš„å®ç°

#### 6. react-art

- **ä½œç”¨**ï¼šç”¨äºç»˜å›¾å’ŒåŠ¨ç”»çš„æ¸²æŸ“å™¨
- **è¯´æ˜**ï¼šå±•ç¤ºäº†è‡ªå®šä¹‰æ¸²æŸ“å™¨çš„å®ç°æ–¹å¼

#### 7. react-test-renderer

- **ä½œç”¨**ï¼šç”¨äºæµ‹è¯•çš„æ¸²æŸ“å™¨
- **è¯´æ˜**ï¼šä¸ä¾èµ– DOM ç¯å¢ƒçš„æµ‹è¯•å·¥å…·

### ğŸ› ï¸ å¼€å‘å·¥å…·åŒ…

#### 8. react-devtools ç³»åˆ—

- **react-devtools** - ç‹¬ç«‹çš„å¼€å‘è€…å·¥å…·
- **react-devtools-extensions** - æµè§ˆå™¨æ‰©å±•
- **react-devtools-shared** - å…±äº«å·¥å…·ä»£ç 
- **react-devtools-core** - æ ¸å¿ƒåŠŸèƒ½

#### 9. eslint-plugin-react-hooks

- **ä½œç”¨**ï¼šReact Hooks çš„ ESLint è§„åˆ™

### ğŸš€ æœåŠ¡ç«¯å’Œæ–°ç‰¹æ€§åŒ…

#### 10. react-server ç³»åˆ—

- **react-server** - React æœåŠ¡ç«¯ç»„ä»¶
- **react-server-dom-webpack** - Webpack é›†æˆ
- **react-server-dom-parcel** - Parcel é›†æˆ
- **è¯´æ˜**ï¼šReact 18+çš„æœåŠ¡ç«¯ç»„ä»¶ç‰¹æ€§

#### 11. å·¥å…·åŒ…

- **react-is** - React å…ƒç´ ç±»å‹åˆ¤æ–­å·¥å…·
- **react-refresh** - çƒ­é‡è½½åŠŸèƒ½
- **shared** - å„åŒ…å…±äº«çš„å·¥å…·å‡½æ•°
- **use-subscription** - è®¢é˜… Hook
- **use-sync-external-store** - å¤–éƒ¨çŠ¶æ€åŒæ­¥ Hook

## React æ¶æ„

äº†è§£äº† React æºç ç›®å½•ä¹‹åï¼Œæˆ‘ä»¬å†æ¥å¯¹ React æ¶æ„æœ‰ä¸ªå¤§ä½“çš„è®¤è¯†ï¼Œäº†è§£ React æ˜¯å¦‚ä½•åœ¨å˜é‡æ›´æ”¹æ—¶ï¼Œé¡µé¢å‘ç”Ÿæ›´æ–°æ¸²æŸ“çš„ã€‚

### æ•´ä½“æ¶æ„è®¾è®¡

![image](images/1-1.png)
React æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦å±‚æ¬¡ï¼š

#### 1. è°ƒåº¦å±‚ï¼ˆSchedulerï¼‰

**æºç ä½ç½®**ï¼š`packages/scheduler/`

- **æ ¸å¿ƒåŠŸèƒ½**ï¼šä»»åŠ¡è°ƒåº¦å’Œä¼˜å…ˆçº§ç®¡ç†
- **ä¸»è¦æ–‡ä»¶**ï¼š
  - `src/Scheduler.js` - è°ƒåº¦å™¨æ ¸å¿ƒé€»è¾‘
  - `src/SchedulerPriorities.js` - ä¼˜å…ˆçº§å®šä¹‰
  - `src/forks/SchedulerHostConfig.default.js` - å®¿ä¸»ç¯å¢ƒé…ç½®

è°ƒåº¦å±‚è´Ÿè´£ï¼š

- æ—¶é—´åˆ‡ç‰‡ï¼ˆTime Slicingï¼‰
- ä»»åŠ¡ä¼˜å…ˆçº§æ’åº
- å¯ä¸­æ–­çš„æ¸²æŸ“è¿‡ç¨‹
- æµè§ˆå™¨ç©ºé—²æ—¶é—´åˆ©ç”¨

#### 2. åè°ƒå±‚ï¼ˆReconcilerï¼‰

**æºç ä½ç½®**ï¼š`packages/react-reconciler/`

- **æ ¸å¿ƒåŠŸèƒ½**ï¼šè™šæ‹Ÿ DOM diff ç®—æ³•å’Œ Fiber æ¶æ„
- **ä¸»è¦æ–‡ä»¶**ï¼š
  - `src/ReactFiberReconciler.js` - åè°ƒå™¨å…¥å£
  - `src/ReactFiberWorkLoop.js` - å·¥ä½œå¾ªç¯
  - `src/ReactFiberBeginWork.js` - å¼€å§‹å·¥ä½œé˜¶æ®µ
  - `src/ReactFiberCompleteWork.js` - å®Œæˆå·¥ä½œé˜¶æ®µ
  - `src/ReactFiberCommitWork.js` - æäº¤é˜¶æ®µ

åè°ƒå±‚è´Ÿè´£ï¼š

- Virtual DOM æ ‘çš„æ„å»ºå’Œæ¯”è¾ƒ
- Fiber èŠ‚ç‚¹çš„åˆ›å»ºå’Œæ›´æ–°
- ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å‰¯ä½œç”¨ï¼ˆEffectsï¼‰æ”¶é›†

#### 3. æ¸²æŸ“å±‚ï¼ˆRendererï¼‰

**æºç ä½ç½®**ï¼š`packages/react-dom/`ã€`packages/react-native-renderer/` ç­‰

- **æ ¸å¿ƒåŠŸèƒ½**ï¼šå°†è™šæ‹Ÿ DOM è½¬æ¢ä¸ºå®é™…çš„ UI
- **ä¸»è¦æ–‡ä»¶**ï¼ˆä»¥ react-dom ä¸ºä¾‹ï¼‰ï¼š
  - `src/client/ReactDOMRoot.js` - æ ¹èŠ‚ç‚¹ç®¡ç†
  - `src/client/ReactDOMComponent.js` - DOM ç»„ä»¶å¤„ç†
  - `src/events/DOMPluginEventSystem.js` - äº‹ä»¶ç³»ç»Ÿ
  - `src/server/ReactDOMServerFormatConfig.js` - æœåŠ¡ç«¯æ¸²æŸ“

### æ›´æ–°æµç¨‹

![image](images/1-2.png)

#### 1. è§¦å‘æ›´æ–°

**æºç ä½ç½®**ï¼š`packages/react/src/ReactHooks.js`

å½“è°ƒç”¨ `setState` æˆ– `useState` çš„ setter æ—¶ï¼š

```javascript
// useState çš„å®ç°ä½ç½®
// packages/react-reconciler/src/ReactFiberHooks.js
function dispatchSetState(fiber, queue, action) {
  // åˆ›å»ºæ›´æ–°å¯¹è±¡
  const update = createUpdate(eventTime, lane);
  update.action = action;

  // å°†æ›´æ–°åŠ å…¥é˜Ÿåˆ—
  enqueueUpdate(fiber, queue, update, lane);

  // è°ƒåº¦æ›´æ–°
  scheduleUpdateOnFiber(fiber, lane, eventTime);
}
```

#### 2. è°ƒåº¦é˜¶æ®µ

**æºç ä½ç½®**ï¼š`packages/react-reconciler/src/ReactFiberWorkLoop.js`

```javascript
// è°ƒåº¦æ›´æ–°çš„æ ¸å¿ƒå‡½æ•°
function scheduleUpdateOnFiber(fiber, lane, eventTime) {
  // æ ‡è®°ä»å½“å‰fiberåˆ°rootçš„è·¯å¾„
  const root = markUpdateLaneFromFiberToRoot(fiber, lane);

  // æ ‡è®°rootæœ‰å¾…å¤„ç†çš„æ›´æ–°
  markRootUpdated(root, lane, eventTime);

  // ç¡®ä¿rootè¢«è°ƒåº¦
  ensureRootIsScheduled(root, eventTime);
}
```

#### 3. æ¸²æŸ“é˜¶æ®µï¼ˆRender Phaseï¼‰

**æºç ä½ç½®**ï¼š`packages/react-reconciler/src/ReactFiberBeginWork.js`

è¿™ä¸ªé˜¶æ®µæ˜¯å¯ä¸­æ–­çš„ï¼Œä¸»è¦å·¥ä½œï¼š

- æ„å»ºæ–°çš„ Fiber æ ‘
- æ ‡è®°éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹
- æ”¶é›†å‰¯ä½œç”¨

```javascript
// å¼€å§‹å·¥ä½œçš„æ ¸å¿ƒå‡½æ•°
function beginWork(current, workInProgress, renderLanes) {
  switch (workInProgress.tag) {
    case FunctionComponent:
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes
      );
    case ClassComponent:
      return updateClassComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes
      );
    case HostComponent:
      return updateHostComponent(current, workInProgress, renderLanes);
    // ... å…¶ä»–ç»„ä»¶ç±»å‹
  }
}
```

#### 4. æäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰

**æºç ä½ç½®**ï¼š`packages/react-reconciler/src/ReactFiberCommitWork.js`

è¿™ä¸ªé˜¶æ®µæ˜¯åŒæ­¥çš„ï¼Œä¸å¯ä¸­æ–­ï¼š

- æ‰§è¡Œ DOM æ“ä½œ
- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
- æ‰§è¡Œå‰¯ä½œç”¨

```javascript
// æäº¤é˜¶æ®µçš„æ ¸å¿ƒå‡½æ•°
function commitRoot(root) {
  // æäº¤å‰çš„å‡†å¤‡å·¥ä½œ
  commitBeforeMutationEffects(root, finishedWork);

  // æ‰§è¡ŒDOMå˜æ›´
  commitMutationEffects(root, finishedWork, lanes);

  // åˆ‡æ¢fiberæ ‘
  root.current = finishedWork;

  // æäº¤åçš„æ¸…ç†å·¥ä½œ
  commitLayoutEffects(finishedWork, root, lanes);
}
```

## æœ€å

æœ¬æ–‡ç®€å•ä»‹ç»äº†ä¸€ä¸‹ react ç›®å½•ç»“æ„å’Œæ ¸å¿ƒæ¶æ„ï¼Œå…·ä½“çš„ç»†èŠ‚ä¼šåœ¨åç»­å†ä»‹ç»ã€‚
